<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>progress bar</title>
    <style>

        body {
            margin: 0;
            padding: 0;
        }

        #progress {
            width: 1200px;
            height: 51px;
            line-height: 51px;
            border: 1px solid #000;

            margin: 100px auto;
            position: relative;
        }

        #prog_bg {
            width: 1000px;
            height: 35px;
            background-color: #cccccc;
            margin: 0 0;
            border-radius: 8px;

            position: relative;
            top: 8px;
        }

        #prog_fg {
            width: 0;
            height: 35px;
            background-color: skyblue;
            line-height: 51px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;

            position: relative;
        }

        #prog_tag {
            width: 20px;
            height: 51px;
            background-color: magenta;
            border-radius: 8px;

            position: absolute;
            left: 0;
            top: -8px;
        }

        #prog_value {
            width: 50px;
            position: absolute;
            right: 0;
            top: 0;
        }

        header {
            width: 100%;
            height: 50px;
        }

    </style>
</head>
<body>

<!-- 进度条 -- 第二次练习 -->

<header>
    <div id="disp1"></div>
    <div id="disp2"></div>
</header>

<section id="progress">
    <div id="prog_bg">
        <div id="prog_fg">
            <div id="prog_tag"></div>
        </div>
    </div>
    <div id="prog_value">0%</div>
</section>


<script>
    window.onload = function () {
        // get elements' IDs;
        var prog_bg = document.getElementById('prog_bg');
        var prog_fg = document.getElementById('prog_fg');
        var prog_tag = document.getElementById('prog_tag');
        var prog_value = document.getElementById('prog_value');

        var disp1 = document.getElementById('disp1');
        var disp2 = document.getElementById('disp2');

        // listen to mouse down event;
        prog_tag.onmousedown = function (evMouseDown) {

            // get the relative X offset (to the window left border) of the moving tag;
            // 获取鼠标点击位置的初始偏移量，作为后续计算鼠标移动距离的参照点；

            // 初始偏移量在理论上应该是点击位置到“调节块”左边框的距离（值应该会是小于调节块的宽度），但由于offsetLeft受定位影响而clientX不受定位影响（以body/window为基准），如果父元素中存在定位，初始偏移量会出现大于调节块宽度的情况；但后面计算移动长度时使用了mouseMove事件的clientX（即：鼠标的实时位置 --> 距body左边界的距离），用鼠标移动前的clientX和移动后的clientX相减，等于移动长度，计算结果准确，与初始偏移量是否大于调节块的宽度没有关系。

            var initOffsetX = evMouseDown.clientX - this.offsetLeft;    // initial X offset of the Tag
            var prog_bar_length = prog_bg.offsetWidth - prog_tag.offsetWidth;
            disp1.innerHTML = 'initOffsetX: ' + initOffsetX + '<br>' +
                              'clientX: ' + evMouseDown.clientX + '<br>' +
                              'offsetLeft: ' + this.offsetLeft;


            // listen to mouse moment event;
            document.onmousemove = function (evMouseMove) {
                var mouseOffsetX = evMouseMove.clientX - initOffsetX;   // 计算出鼠标移动距离，以调节进度条fg宽度和调节块位置
                var mouseMovePct = 0;    // 移动距离的百分比；
                var rgbR = 0, rgbG = 0, rgbB = 0;   // 进度条变色的颜色变量；

                disp2.innerText = 'mouseOffsetX: ' + mouseOffsetX;

                if (mouseOffsetX <= 0) { // 如果已经移动到进度条的最左侧（偏移量小于0）
                    mouseOffsetX = 0;   // 只能调到进度条最左侧、不能超出/越界；
                } else if (mouseOffsetX >= prog_bar_length) { // 大于等于进度条长度
                    mouseOffsetX = prog_bar_length;  // 只能等于进度条长度
                    }

                // 设置进度条前景的宽度和调节块的位置：
                prog_fg.style.width = mouseOffsetX + 'px';
                prog_tag.style.left = mouseOffsetX + 'px';

                // 设置显示进度百分比：
                mouseMovePct = Math.floor(mouseOffsetX / prog_bar_length * 100);    // 移动百分比，鼠标移动距离除以进度条长度，向下取整；
                prog_value.innerText = mouseMovePct + '%';

                // 设置进度条颜色跟随变化：
                rgbR = (100 - mouseMovePct)/100 * 255;  // 以255为最大值，百分比越大，红色值越小；
                rgbB = mouseMovePct/100 * 255;    // 以255为最大值，百分比越大，蓝色值越大；
                prog_fg.style.backgroundColor = 'rgb(' + rgbR + ',' + rgbG + ',' + rgbB + ')';

                return false;
            }

        };
        document.onmouseup = function () {  // 鼠标点击释放之后，停止鼠标移动事件相关的动作
            this.onmousemove = null;
        }


    }
</script>

</body>
</html>